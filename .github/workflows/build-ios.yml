name: Build iOS

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'src-tauri/**'
      - 'src-ui/**'
      - '.github/workflows/build-ios.yml'
  workflow_dispatch:
    inputs:
      install_to_device:
        description: 'Install to connected iPhone'
        required: false
        default: true
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  build-ios:
    runs-on: [self-hosted, macOS, ios-builder]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          clean: true

      - name: Setup environment
        run: |
          xcodebuild -version
          swift --version
          xcrun --version
          source $HOME/.cargo/env
          export PATH="/opt/homebrew/bin:$HOME/.cargo/bin:$PATH"

      - name: Install dependencies
        run: |
          source $HOME/.cargo/env
          export PATH="/opt/homebrew/bin:$HOME/.cargo/bin:$PATH"
          rustup target add aarch64-apple-ios
          cargo install tauri-cli 2>/dev/null || true
          if ! command -v xcodegen &> /dev/null; then
            brew install xcodegen
          fi

      - name: Unlock Keychain
        run: |
          security unlock-keychain -p "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" ~/Library/Keychains/login.keychain-db
          security set-keychain-settings -t 3600 ~/Library/Keychains/login.keychain-db

      - name: Generate icon
        working-directory: src-tauri
        run: |
          mkdir -p icons
          if [ ! -f icons/icon.png ]; then
            # Use macOS sips to create a simple colored PNG
            # Create a 1x1 pixel and scale it up
            printf '\x89PNG\r\n\x1a\n' > icons/icon.png 2>/dev/null || true
            # Try to use system icon as template
            cp /System/Library/CoreServices/Installer.app/Contents/Resources/Installer.icns icons/ 2>/dev/null || true
            # Or download a simple icon
            curl -fsL "https://raw.githubusercontent.com/tauri-apps/tauri/dev/examples/api/src-tauri/icons/icon.png" -o icons/icon.png 2>/dev/null || true
          fi
          ls -la icons/

      - name: Build iOS app
        working-directory: src-tauri
        env:
          APPLE_DEVELOPMENT_TEAM: "J9YRM3U37D"
        run: |
          source $HOME/.cargo/env
          export PATH="/opt/homebrew/bin:$HOME/.cargo/bin:$PATH"
          export APPLE_DEVELOPMENT_TEAM="J9YRM3U37D"
          if [ ! -d "gen/apple" ]; then
            cargo tauri ios init
          fi
          # Create xcconfig file with zlib linker flag
          echo 'OTHER_LDFLAGS = -lz' > gen/apple/Local.xcconfig
          cargo tauri ios build --target aarch64

      - name: Install to iPhone
        if: github.event.inputs.install_to_device != 'false'
        run: |
          APP_PATH=$(find src-tauri/gen/apple -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "Installing to iPhone..."
            DEVICE_ID="4745B27B-2B68-5164-A053-B869B07EE2CA"
            xcrun devicectl device install app --device "$DEVICE_ID" "$APP_PATH" || echo "Install may require device to be unlocked"
          fi
